{% extends 'base.html' %}
{% block title %}AI 위협 분석 대시보드{% endblock %}

{% block content %}
<div class="flex items-center gap-2 mb-4">
  <button data-tab-target="#tab-heatmap"
    class="tab-btn px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold shadow-card">heatmap</button>
  <button data-tab-target="#tab-flow"
    class="tab-btn px-4 py-2 rounded-xl bg-white text-gray-700 border border-gray-300 text-sm font-semibold hover:bg-gray-50">flow</button>
</div>

<!-- Heatmap -->
<section id="tab-heatmap" class="tab-panel block">
  <div class="grid grid-cols-12 gap-4">
    <div class="col-span-12 bg-white rounded-2xl shadow-card p-4">
      <div class="flex items-center justify-between mb-3 flex-wrap gap-3">
        <h2 id="heatmapTitle" class="text-lg font-bold mb-2">
          TTPs Matrix
        </h2>
        <div class="flex items-center gap-3">
          <span class="text-xs text-gray-500">Events</span>
          <div class="flex items-center gap-2 text-xs">
            <span class="inline-flex items-center gap-1"><i class="legend-box" style="background:#E3E7F1"></i>0</span>
            <span class="inline-flex items-center gap-1"><i class="legend-box" style="background:#C6CBEF"></i>≥1</span>
            <span class="inline-flex items-center gap-1"><i class="legend-box" style="background:#8186D5"></i>≥10</span>
            <span class="inline-flex items-center gap-1"><i class="legend-box"
                style="background:#494CA2"></i>≥100</span>
          </div>
        </div>
      </div>
      <div id="heatmapContainer" class="overflow-auto overflow-y-auto border rounded-xl">
        <table id="heatmapTable" class="min-w-full text-[11px] sm:text-xs">
          <thead>
            <tr id="heatmapHeader" class="bg-gray-50 text-gray-600 font-semibold"></tr>
          </thead>
          <tbody id="heatmapBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- Flow -->
<section id="tab-flow" class="tab-panel hidden">
  <div class="grid grid-cols-12 gap-4">

    <div class="col-span-12 md:col-span-2 bg-white rounded-2xl shadow-card p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-base font-semibold">Mini Heatmap</h2>
      </div>
      <div id="miniHeatmap" class="overflow-auto">
        <div class="grid grid-cols-1 gap-2 text-xs text-gray-600"></div>
      </div>
    </div>

    <div class="col-span-12 md:col-span-7 bg-white rounded-2xl shadow-card p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base font-semibold">공격 흐름</h2>
        <div class="text-xs text-gray-500 flex items-center gap-3">
          <button id="btnExportPng" class="ml-2 px-2 py-1 border rounded">PNG로 저장</button>
        </div>
      </div>
      <div id="flowControls" class="flow-controls mb-3 flex flex-wrap gap-2"></div>
      <div id="flowCanvasWrap"
        class="w-full max-w-full overflow-hidden rounded-xl border border-gray-200 bg-gray-50 flex items-center justify-center">
        <div id="flowCanvas" class="w-full h-[520px] text-gray-400 flex items-center justify-center"></div>
      </div>
    </div>

    <aside class="col-span-12 md:col-span-3 bg-white rounded-2xl shadow-card p-4">
      <h2 class="text-base font-semibold mb-3">Timeline</h2>
      <div id="timelineWrap" class="max-h-[500px] overflow-y-auto pr-2">
        <ol id="timeline" class="relative pl-2 text-xs space-y-3">
          <li class="text-gray-500">플로우/노드를 선택하면 세션 타임라인이 여기에 표시됩니다.</li>
        </ol>
      </div>
    </aside>

    <div class="col-span-12 bg-white rounded-2xl shadow-card p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base font-semibold">이벤트</h2>
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-xs" id="eventsTable">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="p-2">timestamp</th>
              <th class="p-2">src_ip</th>
              <th class="p-2">src_port</th>
              <th class="p-2">dst_ip</th>
              <th class="p-2">dst_port</th>
              <th class="p-2">protocol</th>
              <th class="p-2">fwd_bytes</th>
              <th class="p-2">bwd_bytes</th>
              <th class="p-2">tactic</th>
              <th class="p-2">TID</th>
              <th class="p-2">technique</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="flex items-center justify-end gap-2 mt-3 text-xs">
          <button id="prevPage" class="px-2 py-1 border rounded">이전</button>
          <span id="pageInfo" class="text-gray-500">1 / 1</span>
          <button id="nextPage" class="px-2 py-1 border rounded">다음</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- heatmap modal -->
<div id="heatmapModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/40" onclick="document.getElementById('heatmapModal').classList.add('hidden')"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-3xl rounded-lg p-4">
      <button onclick="document.getElementById('heatmapModal').classList.add('hidden')" class="float-right">✕</button>
      <h3 id="heatmapModalTitle" class="font-semibold"></h3>
      <p id="heatmapModalDesc" class="text-xs text-gray-600"></p>
      <div id="heatmapModalBody" class="mt-3 text-sm"></div>
    </div>
  </div>
</div>

<!-- Event Modal -->
<div id="eventModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
  <div class="min-h-full flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-3xl rounded-2xl shadow-card p-6 relative overflow-y-auto max-h-[90vh]">
      <button id="eventModalClose"
        class="absolute top-3 right-3 w-8 h-8 rounded-full border hover:bg-gray-50">✕</button>
      <h3 class="text-lg font-semibold mb-2" id="eventModalTitle">Raw 이벤트 상세</h3>
      <div id="eventModalBody" class="text-sm overflow-y-auto"></div>
    </div>
  </div>
</div>
{% endblock %}